(function($){
	$.fn.lunaMenu = function( options ) {

		var settings = $.extend( {
			'vertical' : true,
			'mouseover' : true,
			'openDirection' : 'right'
		}, options);

		/* Set start classes for root UL and child */
		function initLunaMenu(el){
			el.addClass('root');
			el.addClass('luna-menu-dropdown');

			/* set class "submenu" for all childs UL */
			el.find('ul').each(function(){
				$(this).addClass('submenu');
			});

			/* set levels to all childrens */
			setChildLevel(el, 1);

			/* set child JS listeners */
			el.find('li').on('mouseover', MouseOver);
			el.find('li').on('mouseout', MouseOut);
		}

		function MouseOver(e){

			var ul = $(this).find('ul').first();

			if(ul.hasClass('active')) return;

			if($(this).parent().hasClass('root')){
				$(this).closest('.root').find('ul.active').removeClass('active');
			}

			ulLeft = 0;
			ulTop = 0;
			parentElWidth = $(this).outerWidth(true);
			parentElHeight = $(this).outerHeight(true);
			parentElPos = $(this).position();
			parentElOffest = $(this).offset();
			winWidth = $(window).width();

			if(!settings.vertical && ul.hasClass('level-1') && !ul.hasClass('active')){
				ulLeft = parentElPos.left;
				ulTop = parentElPos.top + parentElHeight;
			}
			else{
				if((parentElOffest.left + parentElWidth + ul.outerWidth(true)) > winWidth){
					settings.openDirection = 'left';
				}
				if((parentElOffest.left - ul.outerWidth(true)) < 0){
					settings.openDirection = 'right';
				}

				if(settings.openDirection !== 'right'){
					ulLeft = parentElPos.left - ul.outerWidth(true);
				}
				else {
					ulLeft = parentElPos.left + parentElWidth;
				}
				ulTop = parentElPos.top;
			}
			$(this).addClass('active');
			ul.addClass('active').css({
				'position' : 'absolute',
				'z-index' : '900',
				'left' : ulLeft,
				'top' : ulTop
			});
		}

		function MouseOut(e){
			e.stopPropagation();
			$(this).removeClass('active');
			$(this).find('ul.active').removeClass('active');
		}

		/* set level class */
		function setChildLevel(elements, lvl){
			elements.children('li').children('ul').each(function(){
				$(this).addClass('level-' + lvl);
				setChildLevel($(this), (lvl+ 1));
			});
		}

		function anyClick(event){
			if($(event.target).parents('.luna-menu-dropdown').length === 0){
				$(".luna-menu-dropdown").find('.active').removeClass('active');
			}
		};

		$("body, html").on('click', anyClick);

		return this.each(function() {
			initLunaMenu($(this));
		});

	};
})( jQuery );
